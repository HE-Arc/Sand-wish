{% extends "sandwish_app/base_generic.html" %}

{% block content %}

    {% load static %}
    <script type = "text/javascript" src="{% static 'scripts/contribution.js' %}" ></script>

    <a href="{% url 'profile' wishlists_owner.username %}" class="btn btn-outline-secondary btn-sm mt-2">Go back to {{ wishlists_owner.username }}'s profile</a>

    <div class="card w-100 my-2">
        <div class="card-body">
            <h1 class="card-title">{{ wishlist.title }}</h1>
            <p class="card-text">{{ wishlist.description }}</p>
        </div>
    </div>

    <h3 class="mt-4">Wishlist's gifts</h3><hr>

    {% if is_wishlists_owner %}
        <a href="{% url 'gift-create' wishlists_owner.username wishlist.id %}" class="btn btn-success">
            Add a gift
        </a>
    {% endif %}
    <!-- gift.0 = actual gift, gift.1 = total contrib, gift.2 = user contrib, gift.3 = max possible contribution, gift.4 = all contributors
    gift.5 = % of contribution from other people, gift.6 = % of our contribution -->
    {% for gift in gifts %}
        {% if gift.0.validated %}
        <div class="gift-item border rounded shadow-sm my-2 alert-success">
        {% else %}
        <div class="gift-item border rounded shadow-sm my-2 bg-white">
        {% endif %}
            <div class="gift-img rounded ">
                <img class="gift-img" src="{{ gift.0.image.url }}" />
            </div>
            <div class="gift-infos">
                <h4 class="mt-2">{{ gift.0.name }} - <span style="color: grey">{{ gift.0.price }} CHF </span></h4>
                {% if  not gift.0.validated %}
                    <div class="progress my-3">
                        <div class="progress-bar" role="progressbar" style="width: 40%" >{{ gift.1 }}</div>
                        <div class="progress-bar bg-success" role="progressbar" style="width: 10%">{{ gift.2 }}</div>
                    </div>
                {% endif %}
                {% if user.is_authenticated and not is_wishlists_owner and not gift.0.validated %}
                    <div class="gift-contribution">
                        <form method="POST" action="{% url 'create-contribution' %}" id="post-form{{ gift.0.id }}" class="contrib-form" onsubmit="contributionSubmit('{{ gift.0.id }}', '{{ gift.2 }}', '{{ csrf_token }}')">
                            {% csrf_token %}
                            <div class="input-group">
                                <input type="number" id="contribution{{ gift.0.id }}", step="0.5", value="{{ gift.2 }}" min="1" max="{{ gift.3 }}" required="required" class="form-control">
                                <div class="input-group-append">
                                    <input type="submit" value="Contribute" class="btn btn-dark">
                                </div>
                            </div>
                        </form>
                        <div id="contribution-error{{ gift.0.id }}">
                        </div>
                    </div>
                {% endif %}
                {% if gift.0.validated %}
                    <br>
                    <button type="button" class="btn btn-info btn-lg" data-toggle="modal" data-target="#contributors">Show contributors</button>
                    <div id="contributors" class="modal fade" role="dialog">
                        <div class="modal-dialog">
                            <!-- Modal content-->
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h4 class="modal-title">Contributors for {{ gift.0 }}</h4>
                                </div>
                                <div class="modal-body">
                                    <ul>
                                        {% for contributor in gift.4 %}
                                            <li>{{ contributor }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        <div class="gift-actions flex-container">
            {% if gift.0.link != "" %}
                <a href="{{ gift.0.link }}" target="_blank" class="btn btn-info btn-sm"><img src="{% static 'icons/buy-icon.png' %}" /></a>
            {% endif %}

            {% if is_wishlists_owner %}
                {% if not gift.0.validated and gift.1 == gift.0.price %}
                    <a href="{% url 'gift-validate' gift.0.id %}" class="btn btn-primary btn-sm"><img src="{% static 'icons/validate-icon.png' %}" /></a>
                {% endif %}
                <a href="{% url 'gift-delete' gift.0.id %}" class="btn btn-danger btn-sm"><img src="{% static 'icons/delete-icon.png' %}" /></a>
            {% endif %}
        </div>
    </div>
    {% endfor %}
{% endblock %}
