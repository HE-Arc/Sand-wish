{% extends "sandwish_app/base_generic.html" %}

<!-- js include -->
{% load static %}
<!-- <script type = "text/javascript" src = "scripts/contribution.js" ></script> -->
<!-- <script type = "text/javascript" src = "{% static 'scripts/contribution.js' %}" ></script> -->

{% block content %}
<h1>{{ wishlist.title }}</h1>
<p>{{ wishlists_owner.username }}<p>
<p>{{ wishlist.description }}</p>

<a href="{% url 'profile' wishlists_owner.username %}" class="btn btn-info">Get back to {{ wishlists_owner.username }}'s profile</a>

{% if is_wishlists_owner %}
    <a href="{% url 'gift-create' wishlists_owner.username wishlist.id %}" class="btn btn-success">Ajouter un nouveau cadeau</a>
    <a href="{% url 'wishlist-delete' wishlist.id %}" class="btn btn-danger">Supprimer la wishlist</a>
{% endif %}

{% for gift in gifts %}
    {% if gift.validated %}
    <div class="gift-item border my-2 alert-success">
    {% else %}
    <div class="gift-item border my-2 ">
    {% endif %}
        <img class="gift-img" src="{{ gift.image }}" />
        <div class="gift-infos">
            <a href="" >
                <h4>
                    {{ gift.name }}
                </h4>
            </a>
            <div class="">
                {{ gift.price }}
            </div>
        </div>
        <div class="gift-contribution">
            <!-- TODO : check if already a contrib ? ou dans le controller avant ? -->
            <form method="POST" action="{% url 'create-contribution' %}" id="post-form{{ gift.id }}" onsubmit="contributionSubmit('{{ gift.id }}')">
                {% csrf_token %}
                <input type="number" id="contribution{{ gift.id }}" min="1" max="{{ gift.price }}", step="0.5"> <!-- TODO : adapter le max -->
                <input type="submit" value="Post" class="">
            </form>
        </div>

    {% if is_wishlists_owner %}
        <div class="gift-actions">
            {% if gift.link != Null %}
                <a href="{{ gift.link }}" target="_blank" class="btn btn-info">Lien</a>
            {% endif %}
            {% if not gift.validated %}
                <a href="" class="btn btn-primary">Valider</a>
            {% endif %}
            <a href="{% url 'gift-delete' gift.id %}" class="btn btn-danger">Supprimer</a>
        </div>
    {% endif %}
    </div>
{% endfor %}

<script type="text/javascript">
    // Submit post on submit
    function contributionSubmit(giftId)
    {
        event.preventDefault();
        // alert("form submitted, gift id : " + giftId);
        create_contribution(giftId);
    }

    // AJAX for posting
    function create_contribution(giftId) {
        // console.log("create post is working!"); // sanity check
        valueFieldName = '#contribution' + giftId;
        alert("creating contrib for gift : " + giftId + ", with contrib : " + $(valueFieldName).val())

        $.ajax({
            url : "{% url 'create-contribution' %}", // the endpoint
            type : "POST", // http method
            data : {'value' : $(valueFieldName).val(), 'giftId' : giftId, 'csrfmiddlewaretoken' : '{{ csrf_token }}'}, // data sent with the post request

            // handle a successful response
            success : function(json) {
                // $(fieldName).val(''); // remove the value from the input
                // console.log(json); // log the returned json to the console
                console.log("success"); // another sanity check
            },

            // handle a non-successful response
            error : function(xhr,errmsg,err) {
                // TODO : if fail we put the old value back
                console.log("fail");
                    $('#results').html("<div class='alert-box alert radius' data-alert>Oops! We have encountered an error: "+errmsg+
                        " <a href='#' class='close'>&times;</a></div>"); // add the error to the dom
                    console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
            }
        });
    };
</script>

{% endblock %}
